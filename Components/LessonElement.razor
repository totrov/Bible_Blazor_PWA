@namespace BibleComponents
@using Bible_Blazer_PWA.BibleReferenceParse
@using Bible_Blazer_PWA.DomainObjects
@inject BibleService Bible

<div class="card">
    <div class="card-header">
        @if (@ElementData.Children != null)
        {
            <h5 class="card-title">
                @ElementData.Value
                <button type="button" class="btn @(IsOpen ? "btn-outline-primary" : "btn-outline-secondary")" style="display: inline;" @onclick="Toggle">...</button>

                @if (HasBibleReferences)
                {
                    <button type="button" class="btn btn-outline-primary" style="display: inline;" @onclick="ToggleReferences">..</button>
                }
            </h5>
        }
        else
        {
            <span class="card-title">
                @ElementData.Value

                @if (HasBibleReferences)
                {
                    <button type="button" class="btn btn-outline-primary btn-sm" style="display: inline;" @onclick="ToggleReferences">..</button>
                }
            </span>
        }
        @if (HasBibleReferences)
        {
            <ul class="nav nav-tabs card-header-tabs" style="@((RefsAreOpen & IsOpen) ? "" : "display:none;")">
                @{
                    int counter = 0;
                }

                @foreach (BibleReference reference in BibleReferences)
                {
                    int number = counter++;
                    <li class="nav-item">
                        <a class="nav-link @(IsActive(number)?"active":"")" style="color:#007bff" @onclick="@(e => SetActive(e, number))">@reference.ToString()</a>
                    </li>
                }
            </ul>
        }
    </div>
    @{
        int counter1 = 0;
    }
    @foreach (BibleReference reference in BibleReferences)
    {
        int number = counter1++;
        <div class="card-body" style="@((IsActive(number) && RefsAreOpen && IsOpen) ? "":"display:none;") background-color:beige">
            @if (_versesLoaded)
            {
                foreach (BibleService.VersesView view in _versesViewsDictionary[reference.ToString()])
                {
                    <span class="badge badge-primary">@view.Badge</span>
                    <i>@view.RawText.Replace("<J>", "").Replace("</J>", "")</i>
                }
            }
            else
            {
                <span>Загрузка...</span>
            }
        </div>
    }

    @if (@ElementData.Children != null)
    {
        <div class="card-body" style="@(ElementData.Level < parameters.CollapseLevel && IsOpen ? "":"display:none;")">
            @foreach (LessonElementData data in ElementData.Children)
            {
                <LessonElement ElementData="data"></LessonElement>
            }
        </div>
    }

</div>

@code {
    private int activeNumber = 0;
    private bool _versesLoaded = false;
    protected bool RefsAreOpen { get; set; } = true;
    protected bool IsOpen { get; set; } = true;
    protected Dictionary<string, IEnumerable<BibleService.VersesView>> _versesViewsDictionary;

    protected LinkedList<BibleReference> _references;

    [Parameter]
    public LessonElementData ElementData { get; set; }

    [CascadingParameter]
    protected Parameters parameters { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _versesViewsDictionary = new Dictionary<string, IEnumerable<BibleService.VersesView>>();
        foreach (BibleReference reference in BibleReferences)
        {
            _versesViewsDictionary.Add(reference.ToString(), await Bible.GetVersesFromReference(reference));
        }
        _versesLoaded = true;
        parameters.OnReferenceToggle += (sender, args) => { RefsAreOpen = parameters.AreReferencesOpened; };
    }

    public bool HasBibleReferences
    {
        get
        {
            return BibleReferences.Any();
        }
    }

    public LinkedList<BibleReference> BibleReferences
    {
        get
        {
            if (_references == null)
            {
                _references = new Parser().ParseTextLineWithBibleReferences(ElementData.Value.ToString()).GetBibleReferences();
            }
            return _references;
        }
    }

    void ToggleReferences()
    {
        RefsAreOpen = !RefsAreOpen;
    }

    void Toggle()
    {
        IsOpen = !IsOpen;
    }

    private void SetActive(MouseEventArgs e, int buttonNumber)
    {
        activeNumber = buttonNumber;
    }

    private bool IsActive(int buttonNumber)
    {
        return activeNumber == buttonNumber;
    }
}