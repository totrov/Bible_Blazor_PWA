@inherits InteractionComponentBase<HomeInteractionModel>
@using Bible_Blazer_PWA.Config;
@using Bible_Blazer_PWA.DataBase.DTO;
@using Bible_Blazer_PWA.DataSources;
@using Bible_Blazer_PWA.DomainObjects;
@using Bible_Blazer_PWA.Facades;
@using Bible_Blazer_PWA.Services.Menu;
@using Bible_Blazer_PWA.Services;
@using static Bible_Blazer_PWA.DataSources.LessonDS;

@inject MenuService menu
@inject Bible_Blazer_PWA.DataBase.DatabaseJSFacade db;
@inject LessonUpdater updater;


@code {
    private LessonDS _lessonDS { get; set; }
    private SortedDictionary<string, LessonBlock> _blocks;

    protected override async Task OnInitializedAsync()
    {
        _lessonDS = new LessonDS(db);
        _blocks = await _lessonDS.GetBlocks(new DBCache(db));
        menu.Title = $"Планы уроков";
        _ = Task.Run(delegate ()
        {
            menu.ClearMenuButtons();
            menu.Update(this);
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_blocks != null && await updater.CheckUpdateRequired(_blocks))
        {
            await updater.UpdateLessons();
            ReloadPage();
        }
    }

    private void ReloadPage()
    {
        HomeInteractionModel.Apply(true);
    }
}
