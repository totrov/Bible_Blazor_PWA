@page "/"
@using Bible_Blazer_PWA.Components
@using Bible_Blazer_PWA.DataBase.DTO;
@using Bible_Blazer_PWA.DataSources
@using Bible_Blazer_PWA.Extensions
@using Bible_Blazer_PWA.Facades;
@using Bible_Blazer_PWA.Services
@using Bible_Blazer_PWA.Services.Menu
@using Bible_Blazer_PWA.Services.Parse
@using static Bible_Blazer_PWA.DataSources.LessonDS
@using Bible_Blazer_PWA.Config
@using Bible_Blazer_PWA.DomainObjects
@using System.Text.Json
@using System.IO

@inject MenuService menu
@inject HttpClient Http
@inject Corrector Corrector;
@inject Bible_Blazer_PWA.DataBase.DatabaseJSFacade db;
@inject NavigationManager navigation
@inject LessonUpdater updater;

@if (_blocks != null)
{
    <MudList Clickable="false">
        @foreach (LessonBlock block in _blocks.Values)
        {
            var header = block.Lessons.Any()
            ? $"{block.Name} ({block.Lessons.Last().Value.VersionDate.ToRussianDateFormatString()})"
            : block.Name;
            <MudListItem Text="@header">
                <NestedList>
                    @foreach (KeyValuePair<int, LessonLightweightDTO> keyValue in block.Lessons)
                    {
                        var lesson = keyValue.Value;

                        <MudListItem>
                            <NavLink class="nav-link" href="@($"lesson/{lesson.Id}/{Unit.GetUnitNumberByShortName(lesson.UnitId)}")" Match="NavLinkMatch.All">@lesson.Name</NavLink>
                        </MudListItem>
                    }
                </NestedList>
            </MudListItem>
        }
    </MudList>
}

@code {
    private LessonDS _lessonDS { get; set; }
    private SortedDictionary<string, LessonBlock> _blocks;
    private bool updateLessonsWasCalled = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_blocks != null && await updater.CheckUpdateRequired(_blocks))
        {
            IsDisabled = true;
            await updater.UpdateLessons();
            IsDisabled = false;
            ReloadPageInstant();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _lessonDS = new LessonDS(db);
        _blocks = await _lessonDS.GetBlocks(new DBCache(db));
        menu.Title = $"Планы уроков";
        _ = Task.Run(delegate ()
        {
            menu.ClearMenuButtons();
            menu.Update(this);
        });
    }

    private bool _isDisabled = false;
    private bool IsDisabled { get => _isDisabled; set { _isDisabled = value; OnEnableDisable?.Invoke(_isDisabled); } }
    private event Action<bool> OnEnableDisable;

    private async Task ReloadPage()
    {
        await Task.Delay(500);
        var currentUri = navigation.Uri;
        navigation.NavigateTo("/setup");
        navigation.NavigateTo(currentUri);
    }

    private void ReloadPageInstant()
    {
        var currentUri = navigation.Uri;
        navigation.NavigateTo("/setup");
        navigation.NavigateTo(currentUri);
    }

    private void UpdateItemStatus(Services.LoadingItem item, string newStatus)
    {
        item.Status = newStatus;
        StateHasChanged();
    }
}





    @*    <h3>Ниже страницы уроков, сделанные без использования БД (будет удалено позже)</h3>

    <ul>
        <li class="nav-item px-3">
            <NavLink class="nav-link" href="test">
                <span class="oi oi-list-rich" aria-hidden="true"></span> Виды дел
            </NavLink>
        </li>
        <li class="nav-item px-3">
            <NavLink class="nav-link" href="test2">
                <span class="oi oi-list-rich" aria-hidden="true"></span> Виды дел +
            </NavLink>
        </li>
        <li class="nav-item px-3">
            <NavLink class="nav-link" href="lesson1">
                <span class="oi oi-list-rich" aria-hidden="true"></span> Урок 1.
            </NavLink>
        </li>
        <li class="nav-item px-3">
            <NavLink class="nav-link" href="lesson4">
                <span class="oi oi-list-rich" aria-hidden="true"></span> Урок 4.
            </NavLink>
        </li>
        <li class="nav-item px-3">
            <NavLink class="nav-link" href="lesson5">
                <span class="oi oi-list-rich" aria-hidden="true"></span> Урок 5.
            </NavLink>
        </li>
        <li class="nav-item px-3">
            <NavLink class="nav-link" href="lesson6">
                <span class="oi oi-list-rich" aria-hidden="true"></span> Урок 6.
            </NavLink>
        </li>
    </ul>*@